# 濟時 & 國璽雙館別排班系統部署指南

## 📋 部署檢查清單

### ✅ 已完成的程式碼修改

1. **後端 GAS 檔案**
   - ✅ `code.gs` - 支援館別參數，API 自動識別
   - ✅ `schedule_v12.gs` - 支援雙館別總表輸出（濟時3班/國璽8班）
   - ✅ `SimpleStats.gs` - 支援館別參數化

2. **前端檔案**
   - ✅ `index.html` - 濟時樓（藍色主題）
   - ✅ `index_guoxi.html` - 國璽樓（橘色主題）
   - ✅ `js/shift-preference.js` - 濟時樓 JS
   - ✅ `js/shift-preference-guoxi.js` - 國璽樓 JS（8班別）

---

## 🗂️ Google Sheets 工作表設定

### 步驟 1：重新命名現有工作表

將現有的 4 張工作表加上 `_濟時` 後綴：

```
slots       → slots_濟時
responses   → responses_濟時
queue       → queue_濟時
stats       → stats_濟時
```

**操作方式：**
1. 在每個工作表標籤上按右鍵
2. 選擇「重新命名」
3. 加上 `_濟時` 後綴

---

### 步驟 2：建立國璽樓工作表

複製濟時樓的 4 張表，改名為國璽樓版本：

```
slots_國璽      (從 slots_濟時 複製結構，清空資料後填入國璽樓班表)
responses_國璽  (從 responses_濟時 複製結構，清空資料)
queue_國璽      (從 queue_濟時 複製結構，清空資料)
stats_國璽      (從 stats_濟時 複製結構，清空資料)
```

**操作方式：**
1. 在工作表標籤上按右鍵
2. 選擇「建立副本」
3. 重新命名為 `_國璽` 版本
4. 清空資料列（保留標題列）

---

### 步驟 3：填入國璽樓班表資料

在 `slots_國璽` 工作表中填入班表資料：

**欄位結構：**
```
slot_id           | date       | date_label | time_label   | hours
------------------+------------+------------+--------------+-------
2026-01-05_1      | 2026-01-05 | 1/5        | 07:30-11:30  | 4
2026-01-05_2      | 2026-01-05 | 1/5        | 09:00-12:30  | 3.5
2026-01-05_3      | 2026-01-05 | 1/5        | 12:00-15:30  | 3.5
2026-01-05_4      | 2026-01-05 | 1/5        | 13:00-16:30  | 3.5
2026-01-05_5      | 2026-01-05 | 1/5        | 07:30-11:30  | 4
2026-01-05_6      | 2026-01-05 | 1/5        | 12:00-15:30  | 3.5
2026-01-05_7      | 2026-01-05 | 1/5        | 15:30-18:30  | 3
2026-01-05_8      | 2026-01-05 | 1/5        | 19:00-23:00  | 4
```

**班別對應：**
- `_1` = 早1 (平日3樓早午)
- `_2` = 早2 (平日3樓早午)
- `_3` = 午1 (平日3樓早午)
- `_4` = 午2 (平日3樓早午)
- `_5` = 早1 (館日5樓3班)
- `_6` = 午1 (館日5樓3班)
- `_7` = 晚1 (3樓&5樓)
- `_8` = 晚2 (晚間5樓)

---

### 步驟 4：建立總表工作表

建立國璽樓的總表輸出工作表：

1. 建立新工作表，命名為 `國璽總表`
2. 在第 1~5 列加入表頭（可參考「濟時總表」格式）
3. 第 6 列開始是資料列（由程式自動填入）

**欄位結構（A~K 欄）：**
```
A: 日期 | B: 星期 | C: 早1 | D: 早2 | E: 午1 | F: 午2 | G: 早1 | H: 午1 | I: 晚1 | J: 晚2 | K: 備註
```

---

## ⚙️ Google Apps Script 部署

### 步驟 1：上傳 GAS 檔案

將修改後的 GAS 檔案上傳到 Google Apps Script 專案：

1. 開啟 Google Sheets
2. 點選「擴充功能」→「Apps Script」
3. 刪除舊的 `code.gs` 內容，貼上新版本
4. 同樣更新 `schedule_v12.gs` 和 `SimpleStats.gs`
5. 確認 `appsscript.json` 設定正確

### 步驟 2：重新部署 Web App

1. 在 Apps Script 編輯器中，點選「部署」→「管理部署作業」
2. 點選現有部署旁的「編輯」
3. 將「版本」改為「新版本」
4. 點選「部署」
5. **複製新的 Web App URL**（如果 URL 有變，需更新前端）

### 步驟 3：設定時間觸發器

為兩個館別分別建立處理 queue 的觸發器：

1. 在 Apps Script 左側選單點選「觸發器」（時鐘圖示）
2. 點選「新增觸發器」

**濟時樓觸發器：**
- 選擇要執行的函式：`processQueueJishi`
- 選取活動來源類型：`時間驅動`
- 選取時間型觸發條件類型：`分鐘計時器`
- 選取分鐘間隔：`每 5 分鐘`

**國璽樓觸發器：**
- 選擇要執行的函式：`processQueueGuoxi`
- 選取活動來源類型：`時間驅動`
- 選取時間型觸發條件類型：`分鐘計時器`
- 選取分鐘間隔：`每 5 分鐘`

---

## 🌐 前端檔案部署

### 步驟 1：確認 API URL

檢查兩個 JS 檔案的 `API_BASE` 常數是否正確：

```javascript
// js/shift-preference.js
// js/shift-preference-guoxi.js
const API_BASE = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
```

### 步驟 2：上傳到伺服器

將以下檔案上傳到網頁伺服器：

```
index.html                        (濟時樓)
index_guoxi.html                  (國璽樓)
js/
  ├── shift-preference.js         (濟時樓)
  └── shift-preference-guoxi.js   (國璽樓)
```

### 步驟 3：測試存取

**濟時樓：** `https://your-domain.com/index.html`
**國璽樓：** `https://your-domain.com/index_guoxi.html`

---

## 🧪 測試清單

### 濟時樓測試

- [ ] 開啟 `index.html`，背景應為藍色
- [ ] 輸入測試學號和姓名，點選「查詢」
- [ ] 應顯示 3 個班別（早1、午2、午1）
- [ ] 選取時段後點選「提交」
- [ ] 5 分鐘後重新查詢，確認資料已更新
- [ ] 檢查 `responses_濟時` 表有新增記錄
- [ ] 檢查 `stats_濟時` 表有統計資料
- [ ] 檢查「濟時總表」有正確輸出

### 國璽樓測試

- [ ] 開啟 `index_guoxi.html`，背景應為橘色
- [ ] 輸入測試學號和姓名，點選「查詢」
- [ ] 應顯示 8 個班別（早1、早2、午1、午2、早1、午1、晚1、晚2）
- [ ] 選取時段後點選「提交」
- [ ] 5 分鐘後重新查詢，確認資料已更新
- [ ] 檢查 `responses_國璽` 表有新增記錄
- [ ] 檢查 `stats_國璽` 表有統計資料
- [ ] 檢查「國璽總表」有正確輸出（A~K 欄）

### 獨立性測試

- [ ] 濟時樓的員工資料不會出現在國璽樓
- [ ] 國璽樓的員工資料不會出現在濟時樓
- [ ] localStorage 使用不同鍵值（`pt_濟時_staff_id` vs `pt_國璽_staff_id`）
- [ ] 兩個館別可以同時使用，互不影響

---

## 🔧 管理功能

### 手動重算統計

在 Apps Script 編輯器中執行以下函數：

**濟時樓：**
```javascript
updateJishiSummaryAllJishi()
```

**國璽樓：**
```javascript
updateJishiSummaryAllGuoxi()
```

### 只重畫總表（不重算統計）

**濟時樓：**
```javascript
redrawJishiSummaryOnlyJishi()
```

**國璽樓：**
```javascript
redrawJishiSummaryOnlyGuoxi()
```

---

## 🚨 常見問題排查

### 1. 提交後沒有反應
- 檢查瀏覽器主控台是否有錯誤
- 確認 API_BASE URL 正確
- 檢查 `queue_濟時` 或 `queue_國璽` 是否有新增記錄

### 2. 統計沒有更新
- 等待 5 分鐘（觸發器執行間隔）
- 檢查觸發器是否正常運作（Apps Script → 觸發器 → 執行記錄）
- 手動執行 `processQueueJishi()` 或 `processQueueGuoxi()`

### 3. 總表沒有資料
- 檢查 `stats_濟時` 或 `stats_國璽` 是否有資料
- 手動執行 `updateJishiSummaryAllJishi()` 或 `updateJishiSummaryAllGuoxi()`
- 確認總表工作表名稱正確（「濟時總表」或「國璽總表」）

### 4. 資料出現在錯誤的館別
- 檢查前端 HTML 的 `<input id="library-id" value="濟時">` 或 `value="國璽"`
- 檢查 JS 檔案的 `const LIBRARY` 常數
- 清除瀏覽器快取後重新測試

---

## 📝 維護注意事項

1. **修改班表結構時**：
   - 濟時樓：維持 3 班（`_1`, `_2`, `_3`）
   - 國璽樓：維持 8 班（`_1` 到 `_8`）
   - 修改 `schedule_v12.gs` 的 `renderJishiSummary()` 函數

2. **新增館別時**：
   - 在 `code.gs` 的 `VALID_LIBRARIES` 陣列加入新館別
   - 建立對應的工作表（`slots_新館別` 等）
   - 複製前端檔案並修改館別識別

3. **API URL 變更時**：
   - 更新所有 JS 檔案的 `API_BASE` 常數
   - 重新上傳前端檔案

---

## ✅ 完成確認

部署完成後，請確認：

- [x] 所有 GAS 檔案已更新並重新部署
- [x] 所有工作表已正確命名和建立
- [x] 時間觸發器已設定（兩個館別各一個）
- [x] 前端檔案已上傳並可正常存取
- [x] 濟時樓和國璽樓都能正常運作
- [x] 兩個系統完全獨立，互不干擾

---

**部署完成！🎉**

如有問題，請檢查 Apps Script 執行記錄（左側選單 → 執行記錄）查看錯誤訊息。
